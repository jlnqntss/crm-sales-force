<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>52.0</apiVersion>
    <description>SDM: añadir valor de indicador APES</description>
    <environments>Default</environments>
    <formulas>
        <description>Calcula los valores de &quot;Sent notifications&quot; para desmarcar en caso de que se haya dejado de cumplir con la condición.</description>
        <name>SentNotificationPicklist</name>
        <dataType>String</dataType>
        <expression>IF ( {!TargetKPIReached}, &quot;01;&quot; ,  &quot;&quot;)
&amp;
IF({!$Record.EndDate__c} &lt;= TODAY()+7, &quot;02;&quot; , &quot;&quot;)
&amp;
IF( {!$Record.EndDate__c} &lt;= TODAY(),&quot;03;&quot; ,  &quot;&quot;)
&amp;
&quot; &quot;</expression>
    </formulas>
    <formulas>
        <name>TargetKPI</name>
        <dataType>Number</dataType>
        <expression>CASE
(
  {!$Record.Indicator__c},
  &quot;PN&quot;,  {!$Record.TargetKPINumber__c},
  &quot;PoliciesPN&quot;,  {!$Record.TargetKPINumber__c},
  &quot;PoliciesInForce&quot;,  {!$Record.TargetKPINumber__c},
  &quot;Portfolio&quot;,  {!$Record.TargetKPICurrency__c},
  &quot;Ratio_PNIncrease&quot;,  {!$Record.TargetKPIPercent__c},
  &quot;Ratio_PoliciesPNIncreas&quot;,  {!$Record.TargetKPIPercent__c},
  &quot;Ratio_PoliciesInForceIncrease&quot;,  {!$Record.TargetKPIPercent__c},
  &quot;Ratio_PortIncrease&quot;,  {!$Record.TargetKPIPercent__c},
  &quot;Ratio_Claim&quot;,  {!$Record.TargetKPIPercent__c},
  &quot;Ratio_Retention&quot;,  {!$Record.TargetKPIPercent__c},
  &quot;Totaldiscount&quot;,  {!$Record.TargetKPIPercent__c},
  &quot;APES&quot;,  {!$Record.TargetKPICurrency__c},
  0
)</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <description>Calcula si se ha alcanzado el KPI objetivo</description>
        <name>TargetKPIReached</name>
        <dataType>Boolean</dataType>
        <expression>IF 
(
  AND 
  (
    ISPICKVAL( {!$Record.SendNotifications__c}, &quot;01&quot;),
    {!$Record.Actual_KPI__c} &gt;= {!TargetKPI}
  )
  ||
  AND 
  (
    ISPICKVAL( {!$Record.SendNotifications__c}, &quot;02&quot;),
    {!$Record.Actual_KPI__c} &lt;= {!TargetKPI}
  ),
  true,
  false
)</expression>
    </formulas>
    <interviewLabel>SDM - Uncheck Notification {!$Flow.CurrentDateTime}</interviewLabel>
    <label>SDM - Uncheck Notifications</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordUpdates>
        <name>Change_Sent_values</name>
        <label>Change Sent values</label>
        <locationX>109</locationX>
        <locationY>345</locationY>
        <inputAssignments>
            <field>SentNotifications__c</field>
            <value>
                <elementReference>SentNotificationPicklist</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <start>
        <locationX>49</locationX>
        <locationY>23</locationY>
        <connector>
            <targetReference>Change_Sent_values</targetReference>
        </connector>
        <filterLogic>1 OR 2 OR 3 OR 4</filterLogic>
        <filters>
            <field>TargetKPICurrency__c</field>
            <operator>IsChanged</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>TargetKPINumber__c</field>
            <operator>IsChanged</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>TargetKPIPercent__c</field>
            <operator>IsChanged</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>EndDate__c</field>
            <operator>IsChanged</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <object>PlanComercial__c</object>
        <recordTriggerType>Update</recordTriggerType>
        <triggerType>RecordBeforeSave</triggerType>
    </start>
    <status>Active</status>
</Flow>
