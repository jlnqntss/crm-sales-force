<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <description>Se buscar al mejor gestor posible para el correo electrónico, en base al cliente al que pertenece al email y sus oportunidades abiertas</description>
        <name>FindOwnerIdAction</name>
        <label>Buscar Gestor Preferente</label>
        <locationX>903</locationX>
        <locationY>206</locationY>
        <actionName>GenesysFindBestAgentAction</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>InboxChoice</targetReference>
        </connector>
        <faultConnector>
            <targetReference>LogError</targetReference>
        </faultConnector>
        <inputParameters>
            <name>fromId</name>
            <value>
                <elementReference>EmailMessage.FromAddress</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>interactionType</name>
            <value>
                <stringValue>Inbound</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>lookFor</name>
            <value>
                <stringValue>Case</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>scope</name>
            <value>
                <stringValue>all</stringValue>
            </value>
        </inputParameters>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </actionCalls>
    <actionCalls>
        <description>Llamada al Apex invocable que contiene la llamada al Genesys Cloud RoutingWork</description>
        <name>RouteEmailAction</name>
        <label>Enrutar Email a Flow CCS en Genesys Cloud</label>
        <locationX>907</locationX>
        <locationY>399</locationY>
        <actionName>GenesysCloudRouteEmailAction</actionName>
        <actionType>apex</actionType>
        <faultConnector>
            <targetReference>LogError</targetReference>
        </faultConnector>
        <inputParameters>
            <name>emailMessageId</name>
            <value>
                <elementReference>EmailMessage.Id</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>fromAddress</name>
            <value>
                <elementReference>EmailMessage.FromAddress</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>fromName</name>
            <value>
                <elementReference>EmailMessage.FromName</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>ownerId</name>
            <value>
                <elementReference>FindOwnerIdAction.ownerId</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>queueId</name>
            <value>
                <elementReference>GenesysId</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>screenPopRecordId</name>
            <value>
                <elementReference>ScreenPopURL</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>subject</name>
            <value>
                <elementReference>EmailMessage.Subject</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>toAddress</name>
            <value>
                <elementReference>EmailMessage.ToAddress</elementReference>
            </value>
        </inputParameters>
    </actionCalls>
    <apiVersion>50.0</apiVersion>
    <assignments>
        <name>BancaMarchChoice</name>
        <label>Decisión BancaMarch</label>
        <locationX>81</locationX>
        <locationY>537</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_BancaMarch</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>BancSabadellChoice</name>
        <label>Decisión BancSabadell</label>
        <locationX>173</locationX>
        <locationY>704</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_BancSabadell</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>BMWChoice</name>
        <label>Decisión BMW</label>
        <locationX>93</locationX>
        <locationY>424</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_BMW</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>CancelsChoice</name>
        <label>Decisión Cancelaciones</label>
        <locationX>531</locationX>
        <locationY>531</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_Cancelaciones</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>CarChangeChoice</name>
        <label>Decisión Cambio Vehículo</label>
        <locationX>537</locationX>
        <locationY>401</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_Cambio Vehículo</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>ColectivosChoice</name>
        <label>Decisión Colectivos</label>
        <locationX>291</locationX>
        <locationY>637</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_Colectivos</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>DBChoice</name>
        <label>Decisión DB</label>
        <locationX>112</locationX>
        <locationY>294</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_DB</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Default</name>
        <label>Genérico</label>
        <locationX>591</locationX>
        <locationY>237</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_Generico</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>GenericoChoice</name>
        <label>Decisión Genérico</label>
        <locationX>329</locationX>
        <locationY>492</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_Generico</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>GestionOperacionesChoice</name>
        <label>Decisión Gestión Operaciones</label>
        <locationX>231</locationX>
        <locationY>289</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_GestionOperaciones</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>LifeChoice</name>
        <label>Decisión Vida</label>
        <locationX>514</locationX>
        <locationY>765</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_Vida</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>MovilidadChoice</name>
        <label>Decisión Movilidad</label>
        <locationX>316</locationX>
        <locationY>373</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_Movilidad</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>PartnerGenericoChoice</name>
        <label>Decisión Partner Genérico</label>
        <locationX>50</locationX>
        <locationY>693</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_Partner</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>SDCChoice</name>
        <label>Decisión SDC</label>
        <locationX>193</locationX>
        <locationY>465</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_SDC</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>SitedbChoice</name>
        <label>Decisión Sitedb</label>
        <locationX>378</locationX>
        <locationY>735</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_Sitedb</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>SoporteChoice</name>
        <label>Decisión Soporte</label>
        <locationX>412</locationX>
        <locationY>601</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_Soporte</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>TelefonicaChoice</name>
        <label>Decisión Telefónica</label>
        <locationX>166</locationX>
        <locationY>585</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_Telefonica</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>TravelChoice</name>
        <label>Decisión Travel</label>
        <locationX>523</locationX>
        <locationY>657</locationY>
        <assignmentItems>
            <assignToReference>GenesysId</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Email_CCS_Travel</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>RouteEmailAction</targetReference>
        </connector>
    </assignments>
    <decisions>
        <description>Dependiendo del ToAddres del email-to-case, se pueden asignar variables</description>
        <name>InboxChoice</name>
        <label>Decidir según buzón de entrada</label>
        <locationX>398</locationX>
        <locationY>179</locationY>
        <defaultConnector>
            <targetReference>Default</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default</defaultConnectorLabel>
        <rules>
            <name>CarChange</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>cc.cambiovehiculo</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>CarChangeChoice</targetReference>
            </connector>
            <label>Cambio Vehículo</label>
        </rules>
        <rules>
            <name>Cancels</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>cc.anulaciones</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>CancelsChoice</targetReference>
            </connector>
            <label>Cancelaciones</label>
        </rules>
        <rules>
            <name>Travel</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>seguroviajezurich</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>TravelChoice</targetReference>
            </connector>
            <label>Travel</label>
        </rules>
        <rules>
            <name>Life</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>cc.gestionesvida</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>LifeChoice</targetReference>
            </connector>
            <label>Vida</label>
        </rules>
        <rules>
            <name>Movilidad</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>cc.movilidad</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>MovilidadChoice</targetReference>
            </connector>
            <label>Movilidad</label>
        </rules>
        <rules>
            <name>Generico</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>zurichcliente</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>GenericoChoice</targetReference>
            </connector>
            <label>Genérico</label>
        </rules>
        <rules>
            <name>Soporte</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>zurichsoporte</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>SoporteChoice</targetReference>
            </connector>
            <label>Soporte</label>
        </rules>
        <rules>
            <name>Sitedb</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>w-sitedb</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>SitedbChoice</targetReference>
            </connector>
            <label>Sitedb</label>
        </rules>
        <rules>
            <name>Colectivos</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>zurich.colectivos</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>ColectivosChoice</targetReference>
            </connector>
            <label>Colectivos</label>
        </rules>
        <rules>
            <name>GestionOperaciones</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>cc.gestionoperaciones</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>GestionOperacionesChoice</targetReference>
            </connector>
            <label>Gestión Operaciones</label>
        </rules>
        <rules>
            <name>SDCReclamaciones</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>cc.sdc.reclamaciones</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>SDCChoice</targetReference>
            </connector>
            <label>SDC Reclamaciones</label>
        </rules>
        <rules>
            <name>Telefonica</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>cc.telefonica</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>TelefonicaChoice</targetReference>
            </connector>
            <label>Telefónica</label>
        </rules>
        <rules>
            <name>BancSabadell</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>cc.bancsabadell</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>BancSabadellChoice</targetReference>
            </connector>
            <label>BancSabadell</label>
        </rules>
        <rules>
            <name>DB</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>cc.db</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>DBChoice</targetReference>
            </connector>
            <label>DB</label>
        </rules>
        <rules>
            <name>BMW</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>cc.bmw</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>BMWChoice</targetReference>
            </connector>
            <label>BMW</label>
        </rules>
        <rules>
            <name>BancaMarch</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>cc.bancamarch</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>BancaMarchChoice</targetReference>
            </connector>
            <label>BancaMarch</label>
        </rules>
        <rules>
            <name>PartnerGenerico</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>EmailMessage.ToAddress</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>contact.center</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>PartnerGenericoChoice</targetReference>
            </connector>
            <label>Partner Genérico</label>
        </rules>
    </decisions>
    <description>Realiza el enrutamiento de correos electrónicos del buzón de CCS</description>
    <formulas>
        <description>URL de la ficha a abrir con el correo enrutado</description>
        <name>ScreenPopURL</name>
        <dataType>String</dataType>
        <expression>&apos;/lightning/page/recordActionFlow?lightning__flowDevName=CCSSearchAndScreenPop&amp;lightning__flowArgs=&apos;
+ &apos;[{&quot;name&quot;: &quot;phone&quot;, &quot;type&quot;: &quot;String&quot;,&quot;value&quot;: &quot;&apos; + {!EmailMessage.FromAddress} + &apos;&quot;},&apos;
+ &apos;{&quot;name&quot;: &quot;relatedrecordid&quot;, &quot;type&quot;: &quot;String&quot;,&quot;value&quot;: &quot;&apos; + {!EmailMessage.ParentId} + &apos;&quot;},&apos;
+ &apos;{&quot;name&quot;: &quot;recordid&quot;, &quot;type&quot;: &quot;String&quot;,&quot;value&quot;: &quot;&apos; + {!EmailMessage.Parent.AccountId} + &apos;&quot;}]&apos;</expression>
    </formulas>
    <interviewLabel>CCS - Enrutamiento de correos electrónicos {!$Flow.CurrentDateTime}</interviewLabel>
    <label>CCS - Enrutamiento de correos electrónicos</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <description>Deja un registro de log del error producido</description>
        <name>LogError</name>
        <label>Registrar error</label>
        <locationX>1151</locationX>
        <locationY>269</locationY>
        <inputAssignments>
            <field>Level__c</field>
            <value>
                <stringValue>Error</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Message__c</field>
            <value>
                <elementReference>$Flow.FaultMessage</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Record_Object__c</field>
            <value>
                <elementReference>EmailMessage.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Source_Class__c</field>
            <value>
                <stringValue>CCSEmailRoute.flow</stringValue>
            </value>
        </inputAssignments>
        <object>Error_Event__e</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <start>
        <locationX>777</locationX>
        <locationY>48</locationY>
        <connector>
            <targetReference>FindOwnerIdAction</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <variables>
        <name>EmailMessage</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <objectType>EmailMessage</objectType>
    </variables>
    <variables>
        <description>Log de error</description>
        <name>ErrorLogEvent</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Error_Event__e</objectType>
    </variables>
    <variables>
        <description>Es el nombre de la cola de genesys</description>
        <name>GenesysId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
